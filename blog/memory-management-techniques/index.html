<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://www.cloudhypervisor.org/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://www.cloudhypervisor.org/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var b=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,a=localStorage.getItem("theme");b&&a===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),b&&a==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),a==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=https://www.cloudhypervisor.org/main.3112e5fd0b5406f481729d702205e0d5a1bc09eb5701f4bcafd6c04a6fe4d7aa30cd1a5ba5aafebe403e14756f029e686e1e889016fe1a6880124cbcef0b6240.css integrity="sha512-MRLl/QtUBvSBcp1wIgXg1aG8CetXAfS8r9bASm/k16owzRpbpar+vkA+FHVvAp5obh6IkBb+GmiAEky87wtiQA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Memory Management Techniques - Cloud Hypervisor</title><meta name=description content="Depending on the expectations around the workload running in a Virtual Machine (VM), as well as the agreement between a customer and an operator, multiple use cases related to memory management between host and guest arise and they can be addressed through different techniques.
Host Managed # This section is about how memory can be managed by the host, as it knows the VM is going to need more or less memory during its runtime."><link rel=canonical href=https://www.cloudhypervisor.org/blog/memory-management-techniques/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Memory Management Techniques"><meta property="og:description" content="Depending on the expectations around the workload running in a Virtual Machine (VM), as well as the agreement between a customer and an operator, multiple use cases related to memory management between host and guest arise and they can be addressed through different techniques.
Host Managed # This section is about how memory can be managed by the host, as it knows the VM is going to need more or less memory during its runtime."><meta property="og:url" content="https://www.cloudhypervisor.org/blog/memory-management-techniques/"><meta property="og:site_name" content="Cloud Hypervisor"><meta property="article:published_time" content="2022-07-07T08:00:00+00:00"><meta property="article:modified_time" content="2022-07-07T08:00:00+00:00"><meta property="og:image" content="https://www.cloudhypervisor.org/doks.png"><meta property="og:image:alt" content="Cloud Hypervisor"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://www.cloudhypervisor.org/#/schema/organization/1","name":"Cloud Hypervisor","url":"https://www.cloudhypervisor.org/","sameAs":["https://github.com/cloud-hypervisor/cloud-hypervisor"],"logo":{"@type":"ImageObject","@id":"https://www.cloudhypervisor.org/#/schema/image/1","url":"https://www.cloudhypervisor.org/\u003cnil\u003e","width":null,"height":null,"caption":"Cloud Hypervisor"},"image":{"@id":"https://www.cloudhypervisor.org/#/schema/image/1"}},{"@type":"WebSite","@id":"https://www.cloudhypervisor.org/#/schema/website/1","url":"https://www.cloudhypervisor.org/","name":"Cloud Hypervisor","description":"Cloud Hypervisor is an open source Virtual Machine Monitor (VMM) implemented in Rust that focuses on running modern, cloud workloads, with minimal hardware emulation.","publisher":{"@id":"https://www.cloudhypervisor.org/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://www.cloudhypervisor.org/blog/memory-management-techniques/","url":"https://www.cloudhypervisor.org/blog/memory-management-techniques/","name":"Memory Management Techniques","description":"","isPartOf":{"@id":"https://www.cloudhypervisor.org/#/schema/website/1"},"about":{"@id":"https://www.cloudhypervisor.org/#/schema/organization/1"},"datePublished":"2022-07-07T08:00:00CET","dateModified":"2022-07-07T08:00:00CET","breadcrumb":{"@id":"https://www.cloudhypervisor.org/blog/memory-management-techniques/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://www.cloudhypervisor.org/blog/memory-management-techniques/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://www.cloudhypervisor.org/blog/memory-management-techniques/"]}]},{"@type":"BreadcrumbList","@id":"https://www.cloudhypervisor.org/blog/memory-management-techniques/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://www.cloudhypervisor.org","url":"https://www.cloudhypervisor.org","name":"Home"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://www.cloudhypervisor.org/blog/","url":"https://www.cloudhypervisor.org/blog/","name":"Blog"}},{"@type":"ListItem","position":4,"item":{"@id":"https://www.cloudhypervisor.org/blog/memory-management-techniques/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://www.cloudhypervisor.org/#/schema/article/1","headline":"Memory Management Techniques","description":"","isPartOf":{"@id":"https://www.cloudhypervisor.org/blog/memory-management-techniques/"},"mainEntityOfPage":{"@id":"https://www.cloudhypervisor.org/blog/memory-management-techniques/"},"datePublished":"2022-07-07T08:00:00CET","dateModified":"2022-07-07T08:00:00CET","author":{"@id":"https://www.cloudhypervisor.org/#/schema/person/2"},"publisher":{"@id":"https://www.cloudhypervisor.org/#/schema/organization/1"},"image":{"@id":"https://www.cloudhypervisor.org/blog/memory-management-techniques/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://www.cloudhypervisor.org/#/schema/person/2","name":null,"sameAs":[]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://www.cloudhypervisor.org/blog/memory-management-techniques/#/schema/image/2","url":"https://www.cloudhypervisor.org/doks.png","contentUrl":"https://www.cloudhypervisor.org/doks.png","caption":"Memory Management Techniques"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://www.cloudhypervisor.org/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.cloudhypervisor.org/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.cloudhypervisor.org/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://www.cloudhypervisor.org/site.webmanifest></head><body class="blog single"><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=https://www.cloudhypervisor.org/ aria-label="Cloud Hypervisor">Cloud Hypervisor</a>
<button class="btn btn-menu d-block d-md-none order-5" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-start border-0 py-md-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-md-none"></div><div class="offcanvas-header d-md-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=https://www.cloudhypervisor.org/>Cloud Hypervisor</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body px-4"><h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3><ul class="nav flex-column flex-md-row ms-md-n3"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://www.cloudhypervisor.org/docs/prologue/introduction/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1 active" href=https://www.cloudhypervisor.org/blog/>Blog</a></li></ul><hr class="text-black-50 my-4 d-md-none"><h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3><ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://github.com/cloud-hypervisor/cloud-hypervisor><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://join.slack.com/t/cloud-hypervisor/shared_invite/enQtNjY3MTE3MDkwNDQ4LWQ1MTA1ZDVmODkwMWQ1MTRhYzk4ZGNlN2UwNTI3ZmFlODU0OTcwOWZjMTkwZDExYWE3YjFmNzgzY2FmNDAyMjI><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-slack"><path d="M14.5 10c-.83.0-1.5-.67-1.5-1.5v-5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5z"/><path d="M20.5 10H19V8.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/><path d="M9.5 14c.83.0 1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5S8 21.33 8 20.5v-5c0-.83.67-1.5 1.5-1.5z"/><path d="M3.5 14H5v1.5c0 .83-.67 1.5-1.5 1.5S2 16.33 2 15.5 2.67 14 3.5 14z"/><path d="M14 14.5c0-.83.67-1.5 1.5-1.5h5c.83.0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-5c-.83.0-1.5-.67-1.5-1.5z"/><path d="M15.5 19H14v1.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5-.67-1.5-1.5-1.5z"/><path d="M10 9.5C10 8.67 9.33 8 8.5 8h-5C2.67 8 2 8.67 2 9.5S2.67 11 3.5 11h5c.83.0 1.5-.67 1.5-1.5z"/><path d="M8.5 5H10V3.5C10 2.67 9.33 2 8.5 2S7 2.67 7 3.5 7.67 5 8.5 5z"/></svg><small class="ms-2 d-md-none">Slack</small></a></li></ul></div></div><button id=mode class="btn btn-link order-md-1" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></nav></header><div class="wrap container-xxl" role=document><div class=content><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"><article><div class=blog-header><h1>Memory Management Techniques</h1><p><small>Posted July 7, 2022 by <a class="stretched-link position-relative" href=https://www.cloudhypervisor.org/contributors/sebastien-boeuf/>Sebastien Boeuf</a>&nbsp;&dash;&nbsp;<strong>6&nbsp;min read</strong></small><p></div><p class=lead></p><p>Depending on the expectations around the workload running in a Virtual Machine
(VM), as well as the agreement between a customer and an operator, multiple use
cases related to memory management between host and guest arise and they can be
addressed through different techniques.</p><h3 id=host-managed>Host Managed <a href=#host-managed class=anchor aria-hidden=true>#</a></h3><p>This section is about how memory can be managed by the host, as it knows the VM
is going to need more or less memory during its runtime.</p><p>This is particularly well illustrated by the Cloud Native use case, involving
containers being created or destroyed, leading to the need to adjust the amount
of memory available.</p><p>We can also take the example of users running a single VM with a certain amount
of RAM until they need more because a different type of workload requires a
larger amount of memory.</p><p>We don&rsquo;t want to run a very large VM just in case we might need more memory
later because the larger the VM, the more expensive the cost. And that&rsquo;s why
having access to such flexibility is very convenient for our users.</p><h4 id=ballooning>Ballooning <a href=#ballooning class=anchor aria-hidden=true>#</a></h4><p>This technique was the former way of performing some sort of hot plug/unplug
without dealing with the complexity associated with adding or removing memory
slots. The logic is reversed in a sense, as the VM is created with the maximum
amount of memory that can be expected, and a balloon is inflated inside the
guest, in order to reduce the available amount of memory.</p><p>From a host perspective, if the system is running low on memory, inflating the
balloon from one or several VMs can help the host getting some memory back to
keep the system afloat.
On the other hand if the host has enough spare memory to give some more to one
of its VMs, it can deflate the balloon.</p><p>It is important to note that until recently (introduction of <code>virtio-mem</code>),
ballooning was the only reliable way of removing memory from a running VM.</p><h4 id=hot-plug>Hot Plug <a href=#hot-plug class=anchor aria-hidden=true>#</a></h4><p>This is the proper technique for adding or removing memory to a VM, without
using a tool like a balloon. And there are two different ways of performing
memory hot plug, one is through <code>ACPI</code> and the other is with <code>virtio-mem</code>.</p><h5 id=acpi>ACPI <a href=#acpi class=anchor aria-hidden=true>#</a></h5><p>This has been the standard way for hot plugging some memory into a VM for quite
some time. This is because the mechanism is part of the ACPI specification and
has been implemented in guest OSes such as Linux and Windows years ago.</p><p>Depending on the guest OS, limitations might differ, but for instance with Linux
there is no way to plug a memory DIMM smaller than 128 MiB. This doesn&rsquo;t allow
for fine grained hot plug, but that&rsquo;s good enough for practical use cases, as we
usually increase a VM&rsquo;s memory using gigabyte as the unit.</p><p>The main drawback is the hot unplug really. This is inconvenient and complicated
for such operation to succeed because we must remove an entire memory DIMM. For
instance, if we plug an extra 2 GiB to a running VM, and later on we want to
remove only 1 GiB, this won&rsquo;t be possible as we can only remove 2 GiB. Of course
we could have plugged the extra 2 GiB splitting it into 16 DIMMs of 128 MiB, but
we would hit the limit on how many memory slots are actually supported.
And even if we could work around this limitation, main part of the complexity
comes from the fact we have no way to ensure the guest isn&rsquo;t using any of the
memory slot we&rsquo;re trying to remove.
This makes hot unplug a non supported feature with <code>ACPI</code> hot plug mechanism.
This is the reason why before <code>virtio-mem</code> came into the picture, we could
combine <code>ACPI</code> hot plug with <code>balloon</code>, so that we would use the <code>ACPI</code>
mechanism for hot plugging while the balloon would be used for both hot unplug
and fine grained operations.</p><h5 id=virtio-mem>virtio-mem <a href=#virtio-mem class=anchor aria-hidden=true>#</a></h5><p>This fairly recent solution has been introduced to address all use cases we
mentioned so far. It is a full hot plug/unplug solution as it doesn&rsquo;t have any
of the drawbacks from <code>balloon</code> and <code>ACPI</code> hot plug. It allows for fine grained
hot plug/unplug, relying on the <code>virtio-mem</code> driver in the guest to manage small
chunks of memory. Unless you have strong reasons not to use <code>virtio-mem</code> (guest
kernel not recent enough for instance), this should be the standard way of
dynamically managing a VM&rsquo;s memory. This feature is available starting with
Linux 5.8.</p><h3 id=guest-driven>Guest Driven <a href=#guest-driven class=anchor aria-hidden=true>#</a></h3><p>Now that we&rsquo;ve covered how the host can manage the guest memory allocated to a
VM, let&rsquo;s look at the way the guest can notify the host for accurate memory
management.</p><h4 id=free-page-reporting>Free Page Reporting <a href=#free-page-reporting class=anchor aria-hidden=true>#</a></h4><p>In general, when a VM is created with a certain amount of memory, only a small
portion of what is available is actually consumed by the VM after boot. But as
soon as one or multiple workloads run inside the guest, the memory starts being
paged. At this point, let&rsquo;s say 90% of the VM&rsquo;s memory have been allocated, the
guest might start freeing some pages after the workloads have been stopped. This
will have no impact on the amount of memory consumed from a host perspective, as
it has no way to know which pages the guest might have freed.</p><p>When looking for a way to overcommit memory, meaning when running multiple VMs
and the sum of all guest RAMs is higher than what the physical RAM can offer,
being able to free pages based on guest&rsquo;s input is a must. And that&rsquo;s what the
feature <code>free page reporting</code> has been added for in the <code>virtio-balloon</code>
specification.</p><p>This feature requires a <code>virtio-balloon</code> device to be created, but it doesn&rsquo;t
require any balloon because inflating or deflating operations are not part of
the mechanism. When enabled, the guest will have a way of notifying the VMM
about set of pages being freed. Based on this information, the VMM will advise
the host that these pages are no longer in use, which effectively gives some
memory back to the host.</p><p>One small drawback of this feature is that depending on how frequently the guest
reports back to the host, the VMM will have more work and be slightly less
efficient. And that&rsquo;s because the slight drop in performance that could be
observed that we didn&rsquo;t enable this feature by default on Cloud Hypervisor.</p><h4 id=deflate-on-oom>Deflate on OOM <a href=#deflate-on-oom class=anchor aria-hidden=true>#</a></h4><p>When running critical workloads that must not fail, particularly because of
memory pressure in the guest, the feature <code>deflate on OOM</code> can be very
convenient as it will give the guest the power to deflate the <code>balloon</code> when
an Out Of Memory (OOM) event happens.</p><p>Of course this means the <code>balloon</code> must have been previously inflated, otherwise
the guest will have nothing to deflate and no way to release the memory
pressure.</p><h3 id=references>References <a href=#references class=anchor aria-hidden=true>#</a></h3><p>If you want to use these features with Cloud Hypervisor, please refer to the
following documentation:</p><ul><li><a href=https://github.com/cloud-hypervisor/cloud-hypervisor/blob/main/docs/balloon.md>Memory Ballooning</a></li><li><a href=https://github.com/cloud-hypervisor/cloud-hypervisor/blob/main/docs/memory.md>Memory Hot Plug</a></li><li><a href=https://github.com/cloud-hypervisor/cloud-hypervisor/blob/main/docs/balloon.md>Guest Features</a></li></ul></article></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Copyright Â© 2021 Cloud Hypervisor a Series of LF Projects, LLC. For website terms of use, trademark policy, privacy policy and other project policies please see https://lfprojects.org/policies. Rendered with <a href=https://gohugo.io/>Hugo</a>, and <a href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=https://www.cloudhypervisor.org/js/bootstrap.min.53daa52a43bbc3961ee392f2e647f55c17a03e11ecaac945381a973bd40e1e578bb6e3b4fbf4f79d9fcd8dff69892e28029b9af3fcbce3e0532d26e392d200dc.js integrity="sha512-U9qlKkO7w5Ye45Ly5kf1XBegPhHsqslFOBqXO9QOHleLtuO0+/T3nZ/Njf9piS4oApua8/y84+BTLSbjktIA3A==" crossorigin=anonymous defer></script>
<script src=https://www.cloudhypervisor.org/js/highlight.min.604fd5b8f19bc0003a4dafe20e0ac6f7380ef4f61fb9e9a918772db94b2bc1d7db0100f1042a6674ac1f8438f240281f445d3f8ab35cb1696f91def7b7548846.js integrity="sha512-YE/VuPGbwAA6Ta/iDgrG9zgO9PYfuempGHctuUsrwdfbAQDxBCpmdKwfhDjyQCgfRF0/irNcsWlvkd73t1SIRg==" crossorigin=anonymous defer></script>
<script src=https://www.cloudhypervisor.org/main.min.cfa136509b4690212e37c116f5afc6938cf1c5d28348366a61feee1302c067a6e6892a265334fa686ec8cb6c64b2b94d8e269c5fabb6bd568c604ac0a1dc1c9b.js integrity="sha512-z6E2UJtGkCEuN8EW9a/Gk4zxxdKDSDZqYf7uEwLAZ6bmiSomUzT6aG7Iy2xksrlNjiacX6u2vVaMYErAodwcmw==" crossorigin=anonymous defer></script></body></html>